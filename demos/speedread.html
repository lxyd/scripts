<!DOCTYPE html>
<html>
    <!-- Inspired by http://www.spritzinc.com/ -->
    <!-- Strugatskie's text is used for demo -->
    <head>
        <meta charset="utf-8"/>
        <title>Contextual Speed Read</title>
        <style>
            #pnl-read {
                width: 500px;
                height: 200px;
                margin: 150px auto;
                position: relative;
            }
            #frame {
                width: 150px;
                height: 20px;
                border: 2px solid red;
                border-left: none;
                border-right: none;
                position: absolute;
                left: 225px;
                top: 90px;
            }
            #content {
                width: 500px;
                overflow: hidden;
                position: absolute;
            }
            #content P {
                margin-top: 3pt;
                text-indent: 10pt;
                color: #CCC;
            }
            #content .cur {
                color: #000;
            }
            #content .cur A {
                color: #A00;
            }
        </style>
        <script>
            var anchors
              , interval = 120
              , delta = 20
              , contentElem
              , frameElem
              , timeoutId = null
              , nextIdx = 0
              , curWordSpan = null
              , usePunctuation = false
              ;

            function arr(o) { return Array.prototype.slice.apply(o) }
            function $(q) { return document.querySelector(q) }
            function $$(q) { return arr(document.querySelectorAll(q)) }

            window.addEventListener('DOMContentLoaded', onload);

            function onload() {
                // global
                frameElem = $('#frame');
                contentElem = $('#content');
                // local
                var pnlInput = $('#pnl-input')
                  , pnlRead = $('#pnl-read')
                  , btnStart = $('#pnl-input INPUT[type=button]')
                  ;
                pnlInput.style.display="block";
                pnlRead.style.display="none";
                btnStart.addEventListener('click', function() {
                    pnlInput.style.display="none";
                    pnlRead.style.display="block";
                    beginRead();
                });
                btnStart.focus();
            }

            function beginRead() {
                var text = $('#pnl-input TEXTAREA').value;
                text = escapeHtml(text);
                text = spreadAnchors(text);
                text = '<p>' + text.replace(/\n/g, '</p><p>') + '</p>';

                contentElem.innerHTML = text;

                anchors = $$('#content A');
                document.addEventListener('keypress', function(e) {
                    switch (e.keyCode || e.which) {
                        case 's'.charCodeAt(0): startStop(); break;
                        case 'j'.charCodeAt(0): slower(); break;
                        case 'k'.charCodeAt(0): faster(); break;
                    }
                });

                usePunctuation = $('#chk-punktuation').checked;

                tick();
            }

            function escapeHtml(text) {
                return text.replace(/[<>&"]/g, function(c) {
                    switch(c) {
                        case '<': return "&lt;";
                        case '>': return "&gt;";
                        case '&': return "&amp;";
                        case '"': return "&quot;";
                    }
                });
            }

            function spreadAnchors(text) {
                return text.replace(/([^\s-——,.;:!?«»"„“]+)([\s-——,.;:!?«»"„“]{0,3})/g, function(_, w, p) {
                    var c = bestChar(w.length);
                    return '<span>' + w.substring(0, c) +
                        '<a data-l="' + w.length + '" data-p="' + punctuationCoeff(p) + '">' + w[c] + '</a>' +
                        w.substring(c+1) + '</span>' + p;
                });
            }

            function bestChar(l) {
                // http://habrahabr.ru/post/213721/#comment_7348441
                return l == 1 ? 0 : l <= 5 ? 1 : l <= 9 ? 2 : l <= 13 ? 3 : 4;
            }

            function sleepCoefficient(l) {
                // almost random
                return l <= 3 ? 1 : l <= 5 ? 1.1 : l <= 9 ? 1.2 : l <= 13 ? 1.3 : 1.5;
            }

            function punctuationCoeff(p) {
                function charCoeff(c) {
                    // almost random again
                    switch(c) {
                        case ',': return 0.5;
                        case ';': return 0.8;
                        case ':': return 0.8;
                        case '–': return 0.8;
                        case '—': return 0.8;
                        case '.': return 1.5;
                        case '!': return 1.5;
                        case '?': return 1.5;
                        case '\n': return 2;
                        case '-': return 0;
                        default: return 0;
                    }
                }

                return arr(p).reduce(function(coeff, chr) {
                    var chrCoeff = charCoeff(chr);
                    return chrCoeff > coeff ? chrCoeff : coeff;
                }, 0);
            }

            function startStop() {
                if (timeoutId) {
                    clearTimeout(timeoutId);
                    timeoutId = null;
                } else {
                    tick();
                }
            }

            function slower() {
                interval += delta;
            }

            function faster() {
                if (interval > 2*delta) {
                    interval -= delta;
                }
            }

            function tick() {
                if (nextIdx >= anchors.length) {
                    return;
                }
                var a = anchors[nextIdx++]
                  , coeff = sleepCoefficient(parseInt(a.getAttribute('data-l')))
                  , punctCoeff = parseFloat(a.getAttribute('data-p'))
                  ;
                position(a);

                if (curWordSpan != null) {
                    curWordSpan.className = '';
                }
                curWordSpan = a.parentNode;
                curWordSpan.className = 'cur';

                timeoutId = setTimeout(tick, calcPause(interval, coeff, punctCoeff));
            }

            function calcPause(baseInterval, lengthCoeff, punctCoeff) {
                return baseInterval * lengthCoeff + (usePunctuation ? baseInterval * punctCoeff : 0);
            }

            function position(a) {
                var l = a.offsetLeft
                  , t = a.offsetTop
                  , w = a.offsetWidth
                  , h = a.offsetHeight
                  , fy = frameElem.offsetTop + frameElem.offsetHeight / 2 - 2
                  , fx = frameElem.offsetLeft + frameElem.offsetWidth / 4 // closer to the left edge of the frame
                  ;
                contentElem.style.left = (fx - l - w/2) + 'px';
                contentElem.style.top = (fy - t - h/2) + 'px';
            }
        </script>
    </head>
    <body>
        <div id="help">
            Скопируйте текст в поле ввода и нажмите "ПОЕХАЛИ".<br/>
            Во время чтения доступны горячие клавиши: k — быстрее, j — медленнее, s — stop/start.
        </div>
        <div id="pnl-input">
            <textarea>
Ложа Анкиного арбалета была выточена из черной пластмассы, а тетива была из хромистой стали и натягивалась одним движением бесшумно скользящего рычага. Антон новшеств не признавал: у него было доброе боевое устройство в стиле маршала Тоца, короля Пица Первого, окованное черной медью, с колесиком, на которое наматывался шнур из воловьих жил. Что касается Пашки, то он взял пневматический карабин. Арбалеты он считал детством человечества, так как был ленив и неспособен к столярному ремеслу.

Они причалили к северному берегу, где из желтого песчаного обрыва торчали корявые корни мачтовых сосен. Анка бросила рулевое весло и оглянулась. Солнце уже поднялось над лесом, и все было голубое, зеленое и желтое — голубой туман над озером, темно-зеленые сосны и желтый берег на той стороне. И небо над всем этим было ясное, белесовато-синее.

— Ничего там нет,— сказал Пашка.

Ребята сидели, перегнувшись через борт, и глядели в воду.

— Громадная щука,— уверенно сказал Антон.

— С вот такими плавниками? — спросил Пашка.

Антон промолчал. Анка тоже посмотрела в воду, но увидела только собственное отражение.

— Искупаться бы,— сказал Пашка, запуская руку по локоть в воду.— Холодная,— сообщил он.

Антон перебрался на нос и спрыгнул на берег. Лодка закачалась. Антон взялся за борт и выжидательно посмотрел на Пашку. Тогда Пашка поднялся, заложил весло за шею, как коромысло, и, извиваясь нижней частью туловища, пропел:

Старый шкипер Вицлипуцли!

Ты, приятель, не заснул?

Берегись, к тебе несутся

Стаи жареных акул!

Антон молча рванул лодку.

— Эй-эй! — закричал Пашка, хватаясь за борта.

— Почему жареных? — спросила Анка.

— Не знаю,— ответил Пашка. Они выбрались из лодки.— А верно, здорово? Стаи жареных акул!

Они потащили лодку на берег. Ноги проваливались во влажный песок, где было полным-полно высохших иголок и сосновых шишек. Лодка была тяжелая и скользкая, но они выволокли ее до самой кормы и остановились, тяжело дыша.

— Ногу отдавил,— сказал Пашка и принялся поправлять красную повязку на голове. Он внимательно следил за тем, чтобы узел повязки был точно над правым ухом, как у носатых ируканских пиратов.— Жизнь не дорога, о-хэй! — заявил он.

Анка сосредоточенно сосала палец.

— Занозила? — спросил Антон.

— Нет. Содрала. У кого-то из вас такие когти…

— Ну-ка, покажи.

Она показала.

— Да,— сказал Антон.— Травма. Ну, что будем делать?

— На пле-чо — и вдоль берега,— предложил Пашка.

— Стоило тогда вылезать из лодки,— сказал Антон.

— На лодке и курица может,— объяснил Пашка.— А по берегу: тростники — раз, обрывы — два, омуты — три. С налимами. И сомы есть.

— Стаи жареных сомов,— сказал Антон.

— А ты в омут нырял?

— Ну, нырял.

— Я не видел. Не довелось как-то увидеть.

— Мало ли чего ты не видел.

Анка повернулась к ним спиной, подняла арбалет и выстрелила в сосну шагах в двадцати. Посыпалась кора.

— Здорово,— сказал Пашка и сейчас же выстрелил из карабина. Он целился в Анкину стрелу, но промазал.— Дыхание не задержал,— объяснил он.

— А если бы задержал? — спросил Антон. Он смотрел на Анку.

Анка сильным движением оттянула рычаг тетивы. Мускулы у нее были отличные — Антон с удовольствием смотрел, как прокатился под смуглой кожей твердый шарик бицепса.

Анка очень тщательно прицелилась и выстрелила еще раз. Вторая стрела с треском воткнулась в ствол немного ниже первой.

— Зря мы это делаем,— сказала Анка, опуская арбалет.

— Что? — спросил Антон.

— Дерево портим, вот что. Один малек вчера стрелял в дерево из лука, так я его заставила зубами стрелы выдергивать.

— Пашка,— сказал Антон.— Сбегал бы, у тебя зубы хорошие.

— У меня зуб со свистом,— ответил Пашка.

— Ладно,— сказала Анка.— Давайте что-нибудь делать.

— Неохота мне лазить по обрывам,— сказал Антон.

— Мне тоже неохота. Пошли прямо.

— Куда? — спросил Пашка.

— Куда глаза глядят.

— Ну? — сказал Антон.

— Значит, в сайву,— сказал Пашка.— Тошка, пошли на Забытое Шоссе. Помнишь?

— Еще бы!

— Знаешь, Анечка…— начал Пашка.

— Я тебе не Анечка,— резко сказала Анка. Она терпеть не могла, когда ее называли не Анка, а как-нибудь еще.

Антон это хорошо запомнил. Он быстро сказал:

— Забытое Шоссе. По нему не ездят. И на карте его нет. И куда идет, совершенно неизвестно.

— А вы там были?

— Были. Но не успели исследовать.

— Дорога из ниоткуда в никуда,— изрек оправившийся Пашка.

— Это здорово! — сказала Анка. Глаза у нее стали как черные щелки.— Пошли. К вечеру дойдем?

— Ну что ты! До двенадцати дойдем.

Они полезли вверх по обрыву. На краю обрыва Пашка обернулся. Внизу было синее озеро с желтоватыми проплешинами отмелей, лодка на песке и большие расходящиеся круги на спокойной маслянистой воде у берега — вероятно, это плеснула та самая щука. И Пашка ощутил обычный неопределенный восторг, как всегда, когда они с Тошкой удирали из интерната и впереди был день полной независимости с неразведанными местами, с земляникой, с горячими безлюдными лугами, с серыми ящерицами, с ледяной водой в неожиданных родниках. И, как всегда, ему захотелось заорать и высоко подпрыгнуть, и он немедленно сделал это, и Антон, смеясь, поглядел на него, и он увидел в глазах Антона совершенное понимание. А Анка вложила два пальца в рот и лихо свистнула, и они вошли в лес.

Лес был сосновый и редкий, ноги скользили по опавшей хвое. Косые солнечные лучи падали между прямых стволов, и земля была вся в золотых пятнах. Пахло смолой, озером и земляникой; где-то в небе верещали невидимые пичужки.

Анка шла впереди, держа арбалет под мышкой, и время от времени нагибалась за кровавыми, будто лакированными, ягодами земляники. Антон шел следом с добрым боевым устройством маршала Тоца на плече. Колчан с добрыми боевыми стрелами тяжко похлопывал его по заду. Он шел и поглядывал на Анкину шею — загорелую, почти черную, с выступающими позвонками. Иногда он озирался, ища Пашку, но Пашки не было видно, только по временам то справа, то слева вспыхивала на солнце его красная повязка. Антон представил себе, как Пашка бесшумно скользит между соснами с карабином наготове, вытянув вперед хищное худое лицо с облупленным носом. Пашка крался по сайве, а сайва не шутит. Сайва, приятель, спросит — и надо успеть ответить, подумал Антон и пригнулся было, но впереди была Анка, и она могла оглянуться. Получилось бы нелепо.

Анка оглянулась и спросила:

— Вы ушли тихо?

Антон пожал плечами.

— Кто же уходит громко?

— Я, кажется, все-таки нашумела,— озабоченно сказала Анка.— Я уронила таз — и вдруг в коридоре шаги. Наверное, Дева Катя — она сегодня в дежурных. Пришлось прыгать в клумбу. Как ты думаешь, Тошка, что за цветы растут на этой клумбе?

Антон сморщил лоб.

— У тебя под окном? Не знаю. А что?

— Очень упорные цветы. «Не гнет их ветер, не валит буря». В них прыгают несколько лет, а им хоть бы что.

— Интересно,— сказал Антон глубокомысленно. Он вспомнил, что под его окном тоже клумба с цветами, которые «не гнет ветер и не валит буря». Но он никогда не обращал на это внимания.

Анка остановилась, подождала его и протянула горсть земляники. Антон аккуратно взял три ягоды.

— Бери еще,— сказала Анка.

— Спасибо,— сказал Антон.— Я люблю собирать по одной. А Дева Катя вообще ничего, верно?

— Это кому как,— сказала Анка.— Когда человеку каждый вечер заявляют, что у него ноги то в грязи, то в пыли…

Она замолчала. Было удивительно хорошо идти с нею по лесу плечом к плечу вдвоем, касаясь голыми локтями, и поглядывать на нее — какая она красивая, ловкая и необычно доброжелательная и какие у нее большие серые глаза с черными ресницами.

— Да,— сказал Антон, протягивая руку, чтобы снять блеснувшую на солнце паутину.— Уж у нее-то ноги не пыльные. Если тебя через лужи носят на руках, тогда, понимаешь, не запылишься…

— Кто это ее носит?

— Генрих с метеостанции. Знаешь, здоровый такой, с белыми волосами.

— Правда?

— А чего такого? Каждый малек знает, что они влюблены.

Они опять замолчали. Антон глянул на Анку. Глаза у Анки были как черные щелочки.

— А когда это было? — спросила она.

— Да было в одну лунную ночь,— ответил Антон без всякой охоты.— Только ты смотри не разболтай.

Анка усмехнулась.

— Никто тебя за язык не тянул, Тошка,— сказала она.— Хочешь земляники?

Антон машинально сгреб ягоды с испачканной ладошки и сунул в рот. Не люблю болтунов, подумал он. Терпеть не могу трепачей. Он вдруг нашел аргумент.

— Тебя тоже когда-нибудь будут таскать на руках. Тебе приятно будет, если начнут об этом болтать?

— Откуда ты взял, что я собираюсь болтать? — рассеянно сказала Анка.— Я вообще не люблю болтунов.

— Слушай, что ты задумала?

— Ничего особенного.— Анка пожала плечами. Немного погодя она доверительно сообщила: — Знаешь, мне ужасно надоело каждый божий вечер дважды мыть ноги.

Бедная Дева Катя, подумал Антон. Это тебе не сайва.

Они вышли на тропинку. Тропинка вела вниз, и лес становился все темнее и темнее. Здесь буйно росли папоротник и высокая сырая трава. Стволы сосен были покрыты мхом и белой пеной лишайников. Но сайва не шутит. Хриплый голос, в котором не было ничего человеческого, неожиданно проревел:

— Стой! Бросай оружие — ты, благородный дон, и ты, дона!

Когда сайва спрашивает, надо успеть ответить. Точным движением Антон сшиб Анку в папоротники налево, а сам прыгнул в папоротники направо, покатился и залег за гнилым пнем. Хриплое эхо еще отдавалось в стволах сосен, а тропинка была уже пуста. Наступила тишина.

Антон, завалившись на бок, вертел колесико, натягивая тетиву. Хлопнул выстрел, на Антона посыпался какой-то мусор. Хриплый нечеловеческий голос сообщил:

— Дон поражен в пятку!
            </textarea>
            <br/>
            <label><input type="checkbox" checked="checked" id="chk-punktuation" value="punct"/>&nbsp;пунктуационные паузы</label>
            <br/>
            <input type="button" value="ПОЕХАЛИ!"/>
        </div>
        <div id="pnl-read">
            <div id="frame"></div>
            <div id="content"></div>
        </div>
    </body>
</html>
